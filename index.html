<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>LOKE</title>

    <!-- Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <!-- Custom Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

</head>

<body>
<div class="container">
    <nav class="navbar navbar-dark bg-dark nav-bar-expand-lg">
        <!-- Navbar content -->
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src=img/logo-inv-small.png alt="fenix logotype" height="36" class="d-inline-block align-center">
                LOKE</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="navAuth">
                <li class="nav-item">
                  <a class="nav-link" aria-current="page" id="navParticipation" href="#">Närvaro</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" id="navGroups">Grupper</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="navLogout">Logga ut</a>
                  </li>
              </ul>
            </div>
          </div>
      </nav>
    </div>
    <section class="view container" id="groupsView">
        Groups view
    </section>

    <section class="view container" id="loginView">
        <h1>Logga in</h1>
        <input type=text placeholder="epost"  id="userNameInput">
        <input type=password placeholder="lösenord" id=passwordInput>
        <button id=loginButton>Login</button>
    </section>
        <section class="container view" id="participationView">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>Närvaro</h2>
                    <h4>
                        <i class="bi-caret-left-square-fill" style="font-size: 2rem;" data-bind="click: previousDay"></i>
                        <span style="margin-left:30px;margin-right:30px" data-bind="text:displayDate()">
                        </span>
                        <i class="bi-caret-right-square-fill" data-bind="click: nextDay" style="font-size: 2rem;" data-bind="click: previousDay"></i>
                    </h4>
                    <ul class="list-group" data-bind="foreach:participants()">
                        <li class="list-group-item list-group-item-action list-group-item-secondary d-flex justify-content-between align-items-center" 
                            data-bind="click: toggle">
                            <span data-bind="text:name"></span>
                            <span class="badge bg-secondary" data-bind="text:status()"></span>
                    </li>

                    </ul>
                    <button class="btn btn-default" data-bind="click: popup">Lägg till</button>
                </div>
            </div>
        </section>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    <script src="knockout-3.4.2.js"></script>
    <script src="js/jquery-3.51.min.js"></script>
    <script src="lok.js"></script>
    <script>
        let baseUrl = "https://lqk13fbvoa.execute-api.eu-north-1.amazonaws.com/";
        function switchView(id) {
            $("section.view").hide();
            $("#" + id).show();
        }
        $(function(){
            $("#navGroups").click(function(){
                switchView("groupsView");
                let url = baseUrl + "groups";
                $.get(url)
                    .done(function(result){
                        console.log(result);

                    }).fail(function(){
                        window.alert("Kunde inte hämta grupper")
                });
            });

            $("#navParticipation").click(function(){
                switchView("participationView");

            });

            $("#loginButton").click(function(){
                let userName = $("#userNameInput").val();    
                let password = $("#passwordInput").val();
                let url = baseUrl + "login?user="+window.encodeURI(userName) + "&password=" + window.encodeURI(password); 
                $.get(url).done(function(result){
                    window.authToken = result;
                    window.localStorage.setItem("authToken", result);
                    $("#navAuth").show();
                    switchView("participationView");
                    jQuery.ajaxSetup({headers: { Authentication: result}});
                }).fail(function(){
                    window.alert("Fel, försök igen");
                })
            });

            $("#navLogout").click(function(){
                window.localStorage.removeItem("authToken");
                $("#navAuth").hide();
                $("#userNameInput").val("");
                $("#passwordInput").val("");
                switchView("loginView");
                jQuery.ajaxSetup({});
            });

            let authToken = window.localStorage.getItem("authToken");
            if (!authToken) {
                switchView('loginView');
                $("#navAuth").hide();
            } else {
                jQuery.ajaxSetup({headers: { Authentication: authToken}});
                switchView('participationView');
                $("#navAuth").show();
            }

        })
     //if we are logged in, show the participation view directly
     //if not,show the log in
    </script>

</body>

</html>
